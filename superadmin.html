<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Super Admin Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; color: #333; display: flex; height: 100vh; }
        .sidebar { width: 250px; background-color: #1f2937; color: white; padding-top: 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        .main-content { flex-grow: 1; padding: 20px 40px; overflow-y: auto; }
        .sidebar-header { padding: 0 20px 20px; font-size: 1.5em; font-weight: bold; border-bottom: 1px solid #374151; }
        .sidebar-nav { flex-grow: 1; }
        .sidebar-nav button, .logout-btn { width: 100%; padding: 15px 20px; background: none; border: none; color: #d1d5db; text-align: left; font-size: 1em; cursor: pointer; border-bottom: 1px solid #374151; transition: background-color 0.2s, color 0.2s; }
        .sidebar-nav button:hover, .logout-btn:hover { background-color: #374151; color: #ffffff; }
        .sidebar-nav button.active { background-color: #4c5f85; color: #ffffff; font-weight: bold; }
        .logout-btn { border-top: 1px solid #374151; border-bottom: none; }
        .content-section { display: none; }
        .content-section.visible { display: block; }
        h1, h2 { color: #1c1e21; padding-bottom: 10px; margin-bottom: 0; border: none; }
        table { border-collapse: collapse; width: 100%; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
        thead { background-color: #6c757d; color: white; }
        th, td { text-align: left; padding: 12px 15px; border-bottom: 1px solid #ddd; }
        tbody tr { cursor: pointer; transition: background-color 0.2s; }
        tbody tr:hover { background-color: #e9ebee; }
        .action-btn { padding: 6px 12px; margin: 0 5px; font-size: 14px; border-radius: 6px; border: none; cursor: pointer; color: white; }
        .edit-btn { background-color: #007bff; }
        .delete-btn { background-color: #dc3545; }
        .loader { text-align: center; padding: 20px; font-size: 1.2em; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 20px 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; position: relative; }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 2.5em; line-height: 1; cursor: pointer; color: #888; }
        .modal-body { display: grid; grid-template-columns: 1fr 2fr; gap: 15px; margin-top: 15px; }
        .modal-body label { font-weight: bold; text-align: right; padding-top: 5px; }
        .modal-body input, .modal-body select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .modal-actions { margin-top: 20px; text-align: right; }
    </style>
</head>
<body>
<div class="sidebar">
    <div class="sidebar-header">Super Admin</div>
    <div class="sidebar-nav">
        <button id="nav-users" onclick="showSection('users')">Manage Users</button>
        <button id="nav-drafts" onclick="showSection('drafts')">Drafts Sheet</button>
        <button id="nav-approval" onclick="showSection('approval')">Approval Sheet</button>
        <button id="nav-pay" onclick="showSection('pay')">Pay Sheet</button>
    </div>
    <button class="logout-btn" onclick="logoutUser()">Logout</button>
</div>
<div class="main-content">
    <h1 id="welcome-message">Super Admin Dashboard</h1>

    <div id="users-section" class="content-section">
        <h2>User Accounts</h2>
        <div id="users-loader" class="loader">Loading users...</div>
        <table id="users-table" style="display:none;"><thead></thead><tbody></tbody></table>
        <p id="no-users" style="display:none;">No user accounts found.</p>
    </div>

    <div id="drafts-section" class="content-section">
        <h2>Drafts Sheet</h2>
        <div id="drafts-loader" class="loader">Loading drafts...</div>
        <table id="drafts-table" style="display:none;"><thead></thead><tbody></tbody></table>
        <p id="no-drafts" style="display:none;">No drafts found.</p>
    </div>

    <div id="approval-section" class="content-section">
        <h2>Approval Sheet</h2>
        <div id="approval-loader" class="loader">Loading approvals...</div>
        <table id="approval-table" style="display:none;"><thead></thead><tbody></tbody></table>
        <p id="no-approval" style="display:none;">No entries in approval sheet.</p>
    </div>

    <div id="pay-section" class="content-section">
        <h2>Pay Sheet</h2>
        <div id="pay-loader" class="loader">Loading pay entries...</div>
        <table id="pay-table" style="display:none;"><thead></thead><tbody></thead><tbody></tbody></table>
        <p id="no-pay" style="display:none;">No entries in pay sheet.</p>
    </div>
</div>

<div id="modal-overlay" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="closeModal()">&times;</button>
        <h2 id="modal-title">Edit Entry</h2>
        <form id="edit-form">
            <div id="modal-body" class="modal-body"></div>
            <div class="modal-actions">
                <button type="button" class="action-btn" style="background-color:#6c757d;" onclick="closeModal()">Cancel</button>
                <button type="submit" class="action-btn" style="background-color:#007bff;">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxYM9I4sdE9O8OCXBRD3vhvhVC9vBOzfMYPyZpJxY2y6223nDTWcR8hAyTfQKhf-kcnPg/exec";
    let loadedData = {};

    async function callAppsScript(functionName, params = []) {
        const requestData = { action: functionName, params: params };
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(requestData),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            });
            if (!response.ok) {
                throw new Error(`Network response was not ok: ${response.statusText}`);
            }
            return await response.json();
        } catch (error) {
            console.error("Error calling Apps Script:", error);
            return { success: false, message: error.message };
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const userType = localStorage.getItem('approvalType');
        if (userType !== 'SuperAdmin') {
            window.location.href = 'index.html';
            return;
        }
        document.getElementById('welcome-message').textContent += ` (Welcome, Super Admin)`;
        fetchAndRenderData();
        showSection('users');
    });

    function logoutUser() {
        localStorage.clear();
        window.location.href = 'index.html';
    }

    async function fetchAndRenderData() {
        ['users', 'drafts', 'approval', 'pay'].forEach(type => showLoader(type));
        
        const [userData, allData] = await Promise.all([
            callAppsScript('getAllUsers'),
            callAppsScript('getAllData')
        ]);
        
        if (userData.success) {
            loadedData.users = userData.users;
            loadedData.userHeaders = userData.headers;
            renderTable('users', loadedData.users, loadedData.userHeaders);
        } else {
            alert('Failed to load user data: ' + userData.message);
            hideLoader('users');
        }

        if (allData.success) {
            loadedData.drafts = allData.draft.entries;
            loadedData.draftHeaders = allData.draft.headers;
            loadedData.approval = allData.approval.entries;
            loadedData.approvalHeaders = allData.approval.headers;
            loadedData.pay = allData.pay.entries;
            loadedData.payHeaders = allData.pay.headers;

            renderTable('drafts', loadedData.drafts, loadedData.draftHeaders);
            renderTable('approval', loadedData.approval, loadedData.approvalHeaders);
            renderTable('pay', loadedData.pay, loadedData.payHeaders);
        } else {
            alert('Failed to load sheet data: ' + allData.message);
            ['drafts', 'approval', 'pay'].forEach(type => hideLoader(type));
        }
    }

    function renderTable(tableType, data, headers) {
        const table = document.getElementById(`${tableType}-table`);
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');

        thead.innerHTML = '';
        tbody.innerHTML = '';
        document.getElementById(`${tableType}-loader`).style.display = 'none';

        if (!data || data.length === 0) {
            document.getElementById(`no-${tableType}`).style.display = 'block';
            table.style.display = 'none';
            return;
        }
        
        document.getElementById(`no-${tableType}`).style.display = 'none';
        table.style.display = 'table';
        
        const headerRow = document.createElement('tr');
        headers.forEach(h => {
            const th = document.createElement('th');
            th.textContent = h;
            headerRow.appendChild(th);
        });
        const actionsTh = document.createElement('th');
        actionsTh.textContent = 'Actions';
        headerRow.appendChild(actionsTh);
        thead.appendChild(headerRow);
        
        data.forEach((entry, index) => {
            const row = document.createElement('tr');
            headers.forEach(h => {
                const td = document.createElement('td');
                td.textContent = entry[h] || '';
                row.appendChild(td);
            });

            const actionsTd = document.createElement('td');
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.className = 'action-btn edit-btn';
            editBtn.onclick = () => openModal(tableType, entry, index + 2); // Row number is 1-based, plus header row
            actionsTd.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.className = 'action-btn delete-btn';
            deleteBtn.onclick = async () => {
                if (confirm(`Are you sure you want to delete this entry?`)) {
                    showLoader(tableType);
                    let response;
                    if (tableType === 'users') {
                        response = await callAppsScript('deleteUser', [index + 2]);
                    } else {
                        const sheetNames = {
                            'drafts': 'Sheet1',
                            'approval': 'approval',
                            'pay': 'pay'
                        };
                        response = await callAppsScript('deleteSheetEntry', [sheetNames[tableType], index + 2]);
                    }
                    if(response.success) {
                        fetchAndRenderData();
                    } else {
                        alert('Error: ' + response.message);
                        hideLoader(tableType);
                    }
                }
            };
            actionsTd.appendChild(deleteBtn);
            row.appendChild(actionsTd);
            tbody.appendChild(row);
        });
    }

    function showSection(sectionName) {
        document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('visible'));
        document.querySelectorAll('.sidebar-nav button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(sectionName + '-section').classList.add('visible');
        document.getElementById('nav-' + sectionName).classList.add('active');
    }

    let currentEditData = {};
    let currentRowIndex = -1;
    let currentTableType = '';

    function openModal(tableType, entry, rowNumber) {
        currentEditData = entry;
        currentRowIndex = rowNumber;
        currentTableType = tableType;
        const modalBody = document.getElementById('modal-body');
        modalBody.innerHTML = '';
        
        let headersToUse;
        if (tableType === 'users') {
            headersToUse = loadedData.userHeaders;
            document.getElementById('modal-title').textContent = 'Edit User';
        } else if (tableType === 'drafts') {
            headersToUse = loadedData.draftHeaders;
            document.getElementById('modal-title').textContent = 'Edit Draft Entry';
        } else if (tableType === 'approval') {
            headersToUse = loadedData.approvalHeaders;
            document.getElementById('modal-title').textContent = 'Edit Approval Entry';
        } else if (tableType === 'pay') {
            headersToUse = loadedData.payHeaders;
            document.getElementById('modal-title').textContent = 'Edit Pay Entry';
        }

        headersToUse.forEach(header => {
            const value = entry[header] || '';
            const isReadOnly = header === 'Unique ID';
            const inputField = `
                <label for="modal-${header}">${header}</label>
                <input type="text" id="modal-${header}" name="${header}" value="${value}" ${isReadOnly ? 'readonly' : ''} style="${isReadOnly ? 'background-color:#e9ecef;' : ''}">
            `;
            modalBody.innerHTML += inputField;
        });

        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
    }

    document.getElementById('edit-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const updatedEntry = {};
        const formData = new FormData(e.target);
        for (let [key, value] of formData.entries()) {
            updatedEntry[key] = value;
        }

        closeModal();
        showLoader(currentTableType);

        let response;
        if (currentTableType === 'users') {
            response = await callAppsScript('updateSuperAdminUser', [updatedEntry, currentRowIndex]);
        } else {
            const sheetNames = {
                'drafts': 'Sheet1',
                'approval': 'approval',
                'pay': 'pay'
            };
            response = await callAppsScript('updateSheetEntry', [sheetNames[currentTableType], updatedEntry, currentRowIndex]);
        }

        if (response.success) {
            fetchAndRenderData();
        } else {
            alert('Error updating: ' + response.message);
            hideLoader(currentTableType);
        }
    });

    function showLoader(tableType) {
        document.getElementById(`${tableType}-loader`).style.display = 'block';
        document.getElementById(`${tableType}-table`).style.display = 'none';
        document.getElementById(`no-${tableType}`).style.display = 'none';
    }

    function hideLoader(tableType) {
        document.getElementById(`${tableType}-loader`).style.display = 'none';
    }
</script>
</body>
</html>
