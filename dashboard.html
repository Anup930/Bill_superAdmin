<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Super Admin Dashboard - Pro Analysis</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        :root {
            --bg-color: #1a1a2e;
            --card-bg: rgba(255, 255, 255, 0.05);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-color: #e4e6f0;
            --primary-color: #00bcd4; /* A vibrant blue-green */
            --secondary-color: #ff5e62; /* A complementary red */
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f2937, #0d131f);
            margin: 0;
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden; /* Hide overflow for body */
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 250px;
            background-color: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            box-shadow: 2px 0 10px var(--shadow-color);
        }

        .sidebar-header {
            font-size: 1.5em;
            font-weight: 700;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-nav {
            flex-grow: 1;
            margin-top: 20px;
        }

        .sidebar-nav button, .logout-btn {
            width: 100%;
            padding: 15px 20px;
            background: none;
            border: none;
            color: var(--text-color);
            text-align: left;
            font-size: 1em;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .sidebar-nav button:hover, .logout-btn:hover {
            background-color: var(--primary-color);
            transform: translateX(5px);
        }

        .sidebar-nav button.active {
            background-color: var(--primary-color);
            font-weight: 600;
        }
        
        /* --- Main Content --- */
        .main-content {
            flex-grow: 1;
            padding: 40px;
            overflow-y: auto;
            position: relative;
        }

        h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 1.8em;
            font-weight: 600;
            margin-top: 30px;
        }

        .loader {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #aaa;
        }

        /* --- Dashboard Controls --- */
        .dashboard-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }

        .search-container {
            flex: 1;
            max-width: 400px;
        }

        #search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border-radius: 8px;
            font-size: 1em;
        }

        #search-input::placeholder {
            color: #999;
        }

        .filter-buttons, .column-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .column-selector-btn {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .column-selector-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .column-dropdown {
            display: none;
            position: absolute;
            top: 100px; /* Adjust based on your layout */
            right: 40px;
            background: rgba(31, 41, 55, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 20px var(--shadow-color);
            border-radius: 8px;
            padding: 15px;
            z-index: 100;
        }

        .column-dropdown.visible {
            display: block;
        }

        .column-dropdown div {
            padding: 8px;
        }

        .column-dropdown label {
            cursor: pointer;
            font-weight: 300;
        }

        /* --- Card View --- */
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px var(--shadow-color);
            transition: transform 0.4s ease, box-shadow 0.4s ease, background 0.4s ease;
            cursor: pointer;
            position: relative;
            transform-style: preserve-3d;
        }

        .card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-10px) rotateX(2deg) rotateY(-2deg);
            box-shadow: 0 10px 30px var(--shadow-color);
        }

        .card-title {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .card-meta p {
            margin: 8px 0;
            font-size: 0.9em;
            color: #ccc;
        }

        .card-meta b {
            color: var(--text-color);
            font-weight: 600;
        }

        /* --- Status Tracker (Simplified 3D) --- */
        .status-tracker {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .status-step {
            flex: 1;
            text-align: center;
            font-size: 0.8em;
            color: #999;
            position: relative;
        }

        .status-step.completed {
            color: var(--primary-color);
        }

        .status-step::after {
            content: '';
            position: absolute;
            top: 10px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            z-index: -1;
        }

        .status-step:last-child::after {
            display: none;
        }

        .status-step .dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #444;
            margin: 0 auto 5px;
            border: 2px solid var(--border-color);
        }

        .status-step.completed .dot {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: rgba(31, 41, 55, 0.9);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px var(--shadow-color);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid var(--border-color);
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 2em;
            color: #aaa;
            cursor: pointer;
            transition: color 0.2s;
        }

        .modal-close-btn:hover {
            color: var(--secondary-color);
        }

        .modal-body {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-top: 20px;
        }

        .modal-body label {
            font-weight: 600;
            text-align: right;
            padding-top: 10px;
        }

        .modal-body input, .modal-body select, .modal-body textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
        }

        .modal-body input:read-only {
            background-color: rgba(255, 255, 255, 0.05);
            color: #999;
        }

        .modal-actions {
            margin-top: 30px;
            text-align: right;
        }

        .action-btn {
            padding: 10px 20px;
            margin-left: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .edit-btn { background-color: var(--primary-color); }
        .delete-btn { background-color: var(--secondary-color); }
        .cancel-btn { background-color: #6c757d; }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--border-color); padding: 10px; }
            .sidebar-nav { display: flex; flex-direction: row; flex-wrap: wrap; justify-content: space-around; }
            .sidebar-nav button, .logout-btn { padding: 10px; font-size: 0.9em; flex-basis: 45%; text-align: center; }
            .main-content { padding: 20px; }
            .dashboard-controls { flex-direction: column; align-items: stretch; }
            .search-container { max-width: 100%; }
            .column-dropdown { top: 180px; right: 20px; }
        }

        /* New styles for Dashboard section */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 20px var(--shadow-color);
            text-align: center;
        }

        .stat-card h3 {
            margin: 0;
            font-size: 2em;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-card p {
            font-size: 1em;
            color: #999;
            margin-top: 5px;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 20px var(--shadow-color);
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 40px;
        }

        .chart-box {
            position: relative;
            height: 350px;
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }
    </style>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <div class="sidebar">
        <div class="sidebar-header">Super Admin</div>
        <div class="sidebar-nav">
            <button id="nav-dashboard" onclick="showSection('dashboard')">Dashboard</button>
            <button id="nav-users" onclick="showSection('users')">Manage Users</button>
            <button id="nav-drafts" onclick="showSection('drafts')">Drafts Sheet</button>
            <button id="nav-approval" onclick="showSection('approval')">Approval Sheet</button>
            <button id="nav-pay" onclick="showSection('pay')">Pay Sheet</button>
        </div>
        <button class="logout-btn" onclick="logoutUser()">Logout</button>
    </div>
    <div class="main-content">
        <h1 id="welcome-message">Super Admin Dashboard</h1>

        <div id="dashboard-section" class="content-section">
            <h2>Overview</h2>
            <div id="dashboard-loader" class="loader">Loading dashboard data...</div>
            <div id="dashboard-stats" class="dashboard-stats" style="display: none;"></div>

            <div id="dashboard-charts" class="chart-grid" style="display: none;">
                <div class="chart-container">
                    <h3 class="chart-title">Approval Status Breakdown</h3>
                    <div class="chart-box">
                        <canvas id="approvalStatusChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Payment Status Breakdown</h3>
                    <div class="chart-box">
                        <canvas id="payStatusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="users-section" class="content-section">
            <h2>User Accounts</h2>
            <div class="dashboard-controls">
                <div class="search-container"><input type="text" id="users-search" placeholder="Search users..."></div>
                <div class="column-selector" id="users-selector"></div>
            </div>
            <div id="users-loader" class="loader">Loading users...</div>
            <div id="users-container" class="card-container"></div>
            <p id="no-users" style="display:none;">No user accounts found.</p>
        </div>

        <div id="drafts-section" class="content-section">
            <h2>Drafts Sheet</h2>
            <div class="dashboard-controls">
                <div class="search-container"><input type="text" id="drafts-search" placeholder="Search drafts..."></div>
                <div class="column-selector" id="drafts-selector"></div>
            </div>
            <div id="drafts-loader" class="loader">Loading drafts...</div>
            <div id="drafts-container" class="card-container"></div>
            <p id="no-drafts" style="display:none;">No drafts found.</p>
        </div>

        <div id="approval-section" class="content-section">
            <h2>Approval Sheet</h2>
            <div class="dashboard-controls">
                <div class="search-container"><input type="text" id="approval-search" placeholder="Search approvals..."></div>
                <div class="column-selector" id="approval-selector"></div>
            </div>
            <div id="approval-loader" class="loader">Loading approvals...</div>
            <div id="approval-container" class="card-container"></div>
            <p id="no-approval" style="display:none;">No entries in approval sheet.</p>
        </div>

        <div id="pay-section" class="content-section">
            <h2>Pay Sheet</h2>
            <div class="dashboard-controls">
                <div class="search-container"><input type="text" id="pay-search" placeholder="Search payments..."></div>
                <div class="column-selector" id="pay-selector"></div>
            </div>
            <div id="pay-loader" class="loader">Loading pay entries...</div>
            <div id="pay-container" class="card-container"></div>
            <p id="no-pay" style="display:none;">No entries in pay sheet.</p>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal()">&times;</button>
            <h2 id="modal-title">Edit Entry</h2>
            <form id="edit-form">
                <div id="modal-body" class="modal-body"></div>
                <div class="modal-actions">
                    <button type="button" class="action-btn cancel-btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="action-btn edit-btn">Save Changes</button>
                    <button type="button" class="action-btn delete-btn" id="delete-btn">Delete</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxYM9I4sdE9O8OCXBRD3vhvhVC9vBOzfMYPyZpJxY2y6223nDTWcR8hAyTfQKhf-kcnPg/exec";
        const DEFAULT_VISIBLE_COLS = ['InvoiceNumber', 'Vendor', 'Company', 'FinalAmountPayable'];
        const STATUS_MAP = {
            'AccountantApproval': 'Accountant Approved',
            'CFOApproval': 'CFO Approved',
            'HOD Approval Status': 'HOD Approved',
            'Final Approval Status': 'Final Approved',
            'Pay Status': 'Payment Completed'
        };

        let loadedData = {};
        let currentTableType = '';
        let currentRowIndex = -1;
        let currentHeaders = {};
        
        async function callAppsScript(functionName, params = []) {
            const requestData = { action: functionName, params: params };
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(requestData),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error("Error calling Apps Script:", error);
                return { success: false, message: error.message };
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const userType = localStorage.getItem('approvalType');
            if (userType !== 'SuperAdmin') {
                window.location.href = 'index.html';
                return;
            }
            document.getElementById('welcome-message').textContent += ` (Welcome, Super Admin)`;
            fetchAndRenderData();
            showSection('dashboard');
        });

        function logoutUser() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        async function fetchAndRenderData() {
            ['dashboard', 'users', 'drafts', 'approval', 'pay'].forEach(type => showLoader(type));
            
            const [userData, allData] = await Promise.all([
                callAppsScript('getAllUsers'),
                callAppsScript('getAllData')
            ]);
            
            if (userData.success) {
                loadedData.users = userData.users.map((item, index) => ({...item, rowIndex: index + 2}));
                currentHeaders.users = userData.headers;
                initializeSection('users', loadedData.users);
            } else {
                alert('Failed to load user data: ' + userData.message);
                hideLoader('users');
            }

            if (allData.success) {
                loadedData.drafts = allData.draft.entries.map((item, index) => ({...item, rowIndex: index + 2}));
                currentHeaders.drafts = allData.draft.headers;
                
                loadedData.approval = allData.approval.entries.map((item, index) => ({...item, rowIndex: index + 2}));
                currentHeaders.approval = allData.approval.headers;
                
                loadedData.pay = allData.pay.entries.map((item, index) => ({...item, rowIndex: index + 2}));
                currentHeaders.pay = allData.pay.headers;

                initializeSection('drafts', loadedData.drafts);
                initializeSection('approval', loadedData.approval);
                initializeSection('pay', loadedData.pay);
                renderDashboard(); // Render dashboard after all data is loaded
            } else {
                alert('Failed to load sheet data: ' + allData.message);
                ['drafts', 'approval', 'pay'].forEach(type => hideLoader(type));
            }
        }
        
        function renderDashboard() {
            const dashboardContainer = document.getElementById('dashboard-stats');
            dashboardContainer.innerHTML = '';
            dashboardContainer.style.display = 'grid';
            document.getElementById('dashboard-loader').style.display = 'none';

            const stats = {
                'Total Users': loadedData.users.length,
                'Drafts Entries': loadedData.drafts.length,
                'Approval Entries': loadedData.approval.length,
                'Pay Entries': loadedData.pay.length
            };

            for (const [key, value] of Object.entries(stats)) {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `<h3>${value}</h3><p>${key}</p>`;
                dashboardContainer.appendChild(card);
            }

            // Render charts
            renderApprovalChart();
            renderPayChart();
            document.getElementById('dashboard-charts').style.display = 'grid';
        }

        function renderApprovalChart() {
            const approvalData = loadedData.approval;
            const statusCounts = {};
            const finalApprovalHeader = 'Final Approval Status';

            approvalData.forEach(entry => {
                const status = entry[finalApprovalHeader] || 'N/A';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const labels = Object.keys(statusCounts);
            const data = Object.values(statusCounts);
            const backgroundColors = [
                'rgba(76, 175, 80, 0.8)',  // Green for Approved
                'rgba(255, 193, 7, 0.8)',  // Amber for Pending
                'rgba(244, 67, 54, 0.8)',  // Red for Rejected
                'rgba(158, 158, 158, 0.8)' // Grey for On Hold or N/A
            ];
            
            const ctx = document.getElementById('approvalStatusChart').getContext('2d');
            
            // Destroy any existing chart instance to avoid conflicts
            if (window.approvalStatusChartInstance) {
                window.approvalStatusChartInstance.destroy();
            }

            window.approvalStatusChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: 'white'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderPayChart() {
            const payData = loadedData.pay;
            const statusCounts = {};
            const payStatusHeader = 'Pay Status';

            payData.forEach(entry => {
                const status = entry[payStatusHeader] || 'N/A';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            
            const labels = Object.keys(statusCounts);
            const data = Object.values(statusCounts);
            const backgroundColors = [
                'rgba(0, 188, 212, 0.8)', // Teal
                'rgba(255, 159, 64, 0.8)',  // Orange
                'rgba(255, 99, 132, 0.8)',  // Red
                'rgba(75, 192, 192, 0.8)' // Green
            ];

            const ctx = document.getElementById('payStatusChart').getContext('2d');

            if (window.payStatusChartInstance) {
                window.payStatusChartInstance.destroy();
            }

            window.payStatusChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Entries',
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false,
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: 'white', precision: 0 },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function initializeSection(type, data) {
            const searchInput = document.getElementById(`${type}-search`);
            const searchFunction = () => renderCards(type, data, searchInput.value);
            
            searchInput.oninput = debounce(searchFunction, 300);
            initializeColumnSelector(type, currentHeaders[type]);
            renderCards(type, data);
        }
        
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        function renderCards(type, data, searchTerm = '') {
            const container = document.getElementById(`${type}-container`);
            const noDataEl = document.getElementById(`no-${type}`);
            
            const filteredData = data.filter(entry => {
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                return Object.values(entry).some(value => 
                    String(value).toLowerCase().includes(lowerCaseSearchTerm)
                );
            });

            container.innerHTML = '';
            document.getElementById(`${type}-loader`).style.display = 'none';

            if (!filteredData || filteredData.length === 0) {
                noDataEl.style.display = 'block';
                return;
            }
            
            noDataEl.style.display = 'none';
            
            const visibleCols = JSON.parse(localStorage.getItem(`superadmin-${type}-cols`)) || getDefaultCols(type);
            
            filteredData.forEach(entry => {
                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = () => openModal(type, entry, entry.rowIndex);
                
                let cardContent = `<div class="card-meta">`;
                visibleCols.forEach(col => {
                    if (entry[col] !== undefined) {
                        cardContent += `<p><b>${col.replace(/([A-Z])/g, ' $1').trim()}:</b> ${entry[col]}</p>`;
                    }
                });
                cardContent += `</div>`;
                
                if (type === 'approval' || type === 'pay') {
                    const approvalHeaders = currentHeaders[type].filter(h => h.includes('Approval Status') || h.includes('Pay Status') || h.includes('Approval') || h.includes('Status'));
                    if (approvalHeaders.length > 0) {
                        cardContent += createStatusTracker(entry, approvalHeaders);
                    }
                }

                card.innerHTML = cardContent;
                container.appendChild(card);
            });
        }
        
        function createStatusTracker(entry, headers) {
            let trackerHtml = `<div class="status-tracker">`;
            headers.forEach((header, index) => {
                const status = String(entry[header] || '').toLowerCase();
                const isCompleted = status === 'approved' || status === 'completed';
                const className = isCompleted ? 'completed' : '';
                const stepText = STATUS_MAP[header] || header;
                trackerHtml += `
                    <div class="status-step ${className}">
                        <div class="dot"></div>
                        <span>${stepText}</span>
                    </div>
                `;
            });
            trackerHtml += `</div>`;
            return trackerHtml;
        }

        function getDefaultCols(type) {
            switch(type) {
                case 'users':
                    return ['username', 'approvalType'];
                case 'drafts':
                    return ['InvoiceNumber', 'Vendor', 'FinalAmountPayable'];
                case 'approval':
                    return ['InvoiceNumber', 'Vendor', 'FinalAmountPayable', 'Final Approval Status'];
                case 'pay':
                    return ['InvoiceNumber', 'Vendor', 'FinalAmountPayable', 'Pay Status'];
                default:
                    return [];
            }
        }
        
        function initializeColumnSelector(type, headers) {
            const selectorContainer = document.getElementById(`${type}-selector`);
            const btn = document.createElement('button');
            btn.className = 'column-selector-btn';
            btn.textContent = 'Select Columns';
            const dropdown = document.createElement('div');
            dropdown.className = 'column-dropdown';
            
            let visibleCols = JSON.parse(localStorage.getItem(`superadmin-${type}-cols`)) || getDefaultCols(type);
            
            headers.forEach(header => {
                const optionDiv = document.createElement('div');
                optionDiv.innerHTML = `<input type="checkbox" id="${type}-${header}" value="${header}" ${visibleCols.includes(header) ? 'checked' : ''}><label for="${type}-${header}">${header}</label>`;
                optionDiv.querySelector('input').addEventListener('change', () => {
                    const newCols = Array.from(dropdown.querySelectorAll('input:checked')).map(cb => cb.value);
                    localStorage.setItem(`superadmin-${type}-cols`, JSON.stringify(newCols));
                    renderCards(type, loadedData[type], document.getElementById(`${type}-search`).value);
                });
                dropdown.appendChild(optionDiv);
            });
            
            selectorContainer.innerHTML = '';
            selectorContainer.appendChild(btn);
            selectorContainer.appendChild(dropdown);
            
            btn.addEventListener('click', e => {
                e.stopPropagation();
                document.querySelectorAll('.column-dropdown').forEach(d => {
                    if (d !== dropdown) d.classList.remove('visible');
                });
                dropdown.classList.toggle('visible');
            });
        }

        function showSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('visible'));
            document.querySelectorAll('.sidebar-nav button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(sectionName + '-section').classList.add('visible');
            document.getElementById('nav-' + sectionName).classList.add('active');
            
            if (sectionName !== 'dashboard' && loadedData[sectionName]) {
                renderCards(sectionName, loadedData[sectionName], document.getElementById(`${sectionName}-search`).value);
            } else if (sectionName === 'dashboard' && loadedData.users) {
                renderDashboard();
            }
        }

        function openModal(tableType, entry, rowNumber) {
            currentTableType = tableType;
            currentRowIndex = rowNumber;
            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = '';
            
            const headersToUse = currentHeaders[tableType];
            document.getElementById('modal-title').textContent = `Entry Details - ${tableType}`;
            
            headersToUse.forEach(header => {
                const value = entry[header] || '';
                const isReadOnly = (header === 'Unique ID' || (tableType !== 'users' && header.includes('Status')));
                
                const inputType = (header === 'Pay Status' || header === 'approvalType') ? 'select' : 'text';
                let inputField = '';
                
                if (inputType === 'select') {
                    const options = (header === 'approvalType') ? ['Biller', 'Payer', 'SuperAdmin'] : ['Pending', 'Completed', 'Rejected', 'Hold'];
                    const selectHtml = options.map(opt => `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`).join('');
                    inputField = `<label for="modal-${header}">${header}</label><select id="modal-${header}" name="${header}" ${isReadOnly ? 'disabled' : ''}>${selectHtml}</select>`;
                } else {
                    inputField = `<label for="modal-${header}">${header}</label><input type="text" id="modal-${header}" name="${header}" value="${value}" ${isReadOnly ? 'readonly' : ''} style="${isReadOnly ? 'background-color:#e9ecef;' : ''}">`;
                }
                modalBody.innerHTML += inputField;
            });

            document.getElementById('modal-overlay').style.display = 'flex';
            document.getElementById('delete-btn').onclick = () => deleteEntry(tableType, currentRowIndex);
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        document.getElementById('edit-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const updatedEntry = {};
            const formData = new FormData(e.target);
            for (let [key, value] of formData.entries()) {
                updatedEntry[key] = value;
            }

            closeModal();
            showLoader(currentTableType);

            let response;
            if (currentTableType === 'users') {
                response = await callAppsScript('updateSuperAdminUser', [updatedEntry, currentRowIndex]);
            } else {
                const sheetNames = {
                    'drafts': 'Sheet1',
                    'approval': 'approval',
                    'pay': 'pay'
                };
                response = await callAppsScript('updateSheetEntry', [sheetNames[currentTableType], updatedEntry, currentRowIndex]);
            }

            if (response.success) {
                fetchAndRenderData();
            } else {
                alert('Error updating: ' + response.message);
                hideLoader(currentTableType);
            }
        });

        async function deleteEntry(tableType, rowNumber) {
            if (confirm(`Are you sure you want to delete this entry?`)) {
                closeModal();
                showLoader(tableType);
                
                let response;
                if (tableType === 'users') {
                    response = await callAppsScript('deleteUser', [rowNumber]);
                } else {
                    const sheetNames = {
                        'drafts': 'Sheet1',
                        'approval': 'approval',
                        'pay': 'pay'
                    };
                    response = await callAppsScript('deleteSheetEntry', [sheetNames[tableType], rowNumber]);
                }
                
                if (response.success) {
                    fetchAndRenderData();
                } else {
                    alert('Error: ' + response.message);
                    hideLoader(tableType);
                }
            }
        }

        function showLoader(tableType) {
            document.getElementById(`${tableType}-loader`).style.display = 'block';
            const container = document.getElementById(`${tableType}-container`);
            if (container) container.innerHTML = '';
            const noDataEl = document.getElementById(`no-${tableType}`);
            if (noDataEl) noDataEl.style.display = 'none';
        }

        function hideLoader(tableType) {
             document.getElementById(`${tableType}-loader`).style.display = 'none';
        }
    </script>
</body>
</html>
